{% extends 'panel.html' %}
{% block content %}
{% if terminal != None and terminal.command != None %}
<div class="modal fade" id="modal-confirm" data-backdrop="static">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><i class="fa fa-asterisk"></i> Running Command <small>via shell</small></h4>
			</div>
			<div class="modal-body">
				<div class="box-body table-responsive">
					<div class="box-body">
						<div class="row">
							<div class="col-xs-12">
								<p>Are you sure you wish to run this command?</p>
								<p><code>{{ terminal.command }}</code></p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" id="btn-yes" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-check"></i> Yes</button>
				<button type="button" id="btn-no" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times"></i> No</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	$(function(){
		$('#modal-confirm').modal('show');
		
		$('#btn-no').click(function() {
			{% if return_url != None %}
				window.location = '{{ url_for(return_url) }}';
			{% else %}
				window.location = '/';
			{% endif %}
		});
		
		$('#btn-yes').click(function() {
			update();
		});
	});
</script>
{% endif %}
<style>
	#terminal {
		height: 350px;
		padding: 5px;
		
		color: white;
		background-color: black;
		
		font-family: "Courier New", Courier, monospace;
		
		box-sizing: border-box;
		overflow-y: scroll;
	}
	
	#input, #input input {
		position: relative;
		width: 100%;
		height: 20px;
		margin-top: 1px;
		
		color: white;
		background-color: black;
		
		font-family: "Courier New", Courier, monospace;
	}
	
	#input label {
		position: absolute;
		left: 5px;
	}
	
	#input input {
		position: absolute;
		top: -1px;
		left: 15px;
		
		width: calc(100% - 15px);
		height: 100%;
		
		border: 0;
	}
</style>
<div id="terminal"></div>
<div id="input">
	<label>></label>
	<input type="text" autocomplete="off" />
</div>
<script type="text/javascript">
	$(function() {
		{% if terminal == None or terminal.command == None %}
			update();
		{% endif %}
		
		$('#input input').keyup(function(e) {
			data = $(this).val();
			
			if(e.keyCode == 13)
				data = '\n';
			
			input(data);
			$(this).val('');
		});
	});
	
	function update() {
		$.post(window.location.pathname, { action: 'output' }, function(data) {
			terminal = $('#terminal');
			
			if(data === '0') {
				{% if return_url != None %}
					setTimeout(function() {
						{% if restart == 1 %}
							window.location = '{{ url_for("dashboard.restart", return_url=return_url) }}';
						{% else %}
							window.location = '{{ url_for(return_url) }}';
						{% endif %}
					}, 2000);
				{% endif %}
				return;
			}
			
			if(data['error'] != undefined) {
				terminal.append('<br /><br /><br />Error: ' + data['error'] + '<br /><br /><br /><br />');
			}else{
				for(var i in data)
					terminal.append(data[i] + '<br />');
				setTimeout(update, 500);
			}
			
			terminal.scrollTop(terminal.height() + terminal.scrollTop());
		});
	}
	
	function input(text) {
		if(text == undefined)
			return;
		$.post(window.location.pathname, { action: 'input', input: text });
	}
</script>
{% endblock %}